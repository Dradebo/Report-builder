{"id":"Report-builder-1","title":"Period offset in indicators causes incorrect data values","description":"Analytics API calls do not account for indicator period offsets. When indicators calculate values using previous periods (e.g., \"current month enrollment vs previous month\"), the API query only uses the user-selected period, resulting in incorrect calculations.","design":"**Root Cause:**\nApp.js:168-174 - Analytics route construction uses single period without checking indicator definitions for period offsets.\n\n**Expected Behavior:**\n- Fetch indicator metadata to detect period offsets\n- Construct analytics query with appropriate period range when offset exists\n- Example: If indicator uses -1 month offset and user selects \"January 2024\", query should request \"202312;202401\"\n\n**Files Affected:**\n- src/App.js (handleUpdateInformation function)\n- src/api.routes.js (may need new metadata endpoint)\n\n**Technical Details:**\nDHIS2 indicators can have period offsets in their numerator/denominator expressions. The analytics API requires explicit period parameters for each offset period used in the calculation.","acceptance_criteria":"- [ ] Indicator metadata is fetched before analytics call\n- [ ] Period offsets are detected from indicator definitions\n- [ ] Analytics query includes all required periods for offset calculations\n- [ ] Test with indicator containing -1 month offset shows correct values\n- [ ] Test with indicator containing no offset shows unchanged behavior","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-20T08:58:47.379704+03:00","updated_at":"2025-10-20T08:58:47.379704+03:00"}
{"id":"Report-builder-2","title":"Sequential API calls and state timing cause data overwrites","description":"Data fetching uses sequential for-loop with accumulated local array, but React state updates create race conditions. Different org units show different errors because the data injection reads from potentially stale state.","design":"**Root Cause:**\nApp.js:147-217 - Sequential dimension fetching with accumulated array vs React state timing mismatch\n\n**Current Flow:**\n1. Loop through dimensions sequentially\n2. Accumulate in local `allDataValues` array\n3. Set React state AFTER all fetches\n4. Inject data using local variable (not state)\n\n**Problems:**\n- Sequential fetching is slow (not parallelized)\n- State update happens too late\n- No guarantee that dataValues prop in child components has updated\n- DOM injection may read stale data\n\n**Solution Approach:**\n- Use Promise.all() for parallel fetching\n- Remove intermediate allDataValues array\n- Use functional state update: setDataValues(prev =\u003e [...prev, ...newValues])\n- Add state dependency check before injection","acceptance_criteria":"- [ ] API calls execute in parallel using Promise.all()\n- [ ] Data values state updates correctly for all dimensions\n- [ ] Same report with same filters shows consistent results across multiple generations\n- [ ] Different org units show correct, distinct values\n- [ ] No console errors about stale state or missing data","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-20T08:58:54.213871+03:00","updated_at":"2025-10-20T08:58:54.213871+03:00"}
{"id":"Report-builder-3","title":"Legend selection uses wrong period for offset indicators","description":"Legend matching functions receive user-selected period but apply to values calculated using different periods (due to indicator offset). Correct indicator values get wrong legend colors/images because period mismatch.","design":"**Root Cause:**\nfonctions.js:8-302 - Legend functions (findTheRightLegend, checkColorLegend, etc.) use single period parameter\n\n**Problem Flow:**\n1. User selects \"January 2024\"\n2. Indicator calculates using \"December 2023\" data (due to -1 offset)\n3. Legend function receives \"January 2024\" as period\n4. Finds January 2024 legend ranges\n5. Applies January ranges to December value\n6. Result: Correct value, wrong legend color\n\n**Solution:**\n- Modify legend injection to accept effective period per data point\n- Calculate effective period based on indicator offset metadata\n- Pass correct period to legend matching for each value\n- May need to refactor injectDataIntoHtml to accept period per dataValue\n\n**Files Affected:**\n- src/utils/fonctions.js (checkColorLegend, checkImageLegend, checkLabelLegend, inject_legend)\n- src/App.js (handleUpdateInformation - need to pass period metadata)","acceptance_criteria":"- [ ] Legend functions accept period per data point\n- [ ] Indicator offset metadata is used to calculate effective period\n- [ ] Test: Indicator with offset shows legend from correct period\n- [ ] Test: Indicator without offset shows legend from user-selected period\n- [ ] Legend selection is consistent across different org units for same indicator","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-20T08:58:58.906835+03:00","updated_at":"2025-10-20T08:58:58.906835+03:00","dependencies":[{"issue_id":"Report-builder-3","depends_on_id":"Report-builder-1","type":"blocks","created_at":"2025-10-20T08:59:52.120726+03:00","created_by":"sean"}]}
{"id":"Report-builder-4","title":"DOM element matching fails for org unit hierarchies","description":"cleanAggrateDimensionData sets default \"missing\" legends, then injectDataIntoHtml tries to match data but fails due to org unit ID string parsing issues. Results in correct data being fetched but not injected into correct DOM elements.","design":"**Root Cause:**\nfonctions.js:434-525, 751-795 - Two-phase DOM update with incomplete matching logic\n\n**Problem:**\n1. cleanAggrateDimensionData() sets all cells to \"missing data\" legend\n2. injectDataIntoHtml() loops through dataValues to inject actual values\n3. Nested loop checks: `if (el === dx_id \u0026\u0026 orgUnit === getOrgUnitIdFromParentString(...)?.id)`\n4. getOrgUnitIdFromParentString may return null or wrong ID for complex hierarchies\n5. Cell keeps \"missing data\" legend even though data exists in dataValues array\n\n**Solution:**\n- Add logging to identify which cells fail to match\n- Review getOrgUnitIdFromParentString logic for edge cases\n- Consider changing from nested loop to Map-based lookup for O(1) matching\n- Ensure all HTML element IDs follow consistent format\n- Add fallback handling when orgUnit match fails","acceptance_criteria":"- [ ] All fetched data values are successfully matched to DOM elements\n- [ ] getOrgUnitIdFromParentString handles all org unit hierarchy levels\n- [ ] No \"missing data\" legends appear when data exists in dataValues\n- [ ] Performance improved with Map-based lookup (optional)\n- [ ] Console logging identifies any remaining unmatched cells","status":"open","priority":2,"issue_type":"bug","created_at":"2025-10-20T08:59:02.798146+03:00","updated_at":"2025-10-20T08:59:02.798146+03:00"}
{"id":"Report-builder-5","title":"Fix data inconsistency issues in report generation","description":"Reports show inconsistent data across periods and organisation units. Three root causes identified: (1) period offset in indicators not handled in API calls, (2) sequential fetching with state race conditions, (3) legend period mismatch for offset calculations, (4) DOM matching failures for org hierarchies.","design":"**User-Reported Symptoms:**\n1. Period offset in indicators creates inconsistency in historical comparisons\n2. Different organisation units show different errors\n3. Indicators correct in DHIS2 visualizer show wrong values in Report Builder\n4. Same indicator correct for one org unit, wrong legend for another\n5. Previous troubleshooting pointed to data overwriting and unstable state\n\n**Investigation Findings:**\n- Period offsets in indicator definitions not accounted for in analytics queries\n- Sequential API fetching with local array accumulation vs React state timing issues\n- Legend matching uses user-selected period instead of effective calculation period\n- DOM element matching fails for complex org unit hierarchies\n\n**Sub-tasks:**\n1. Report-builder-1: Fix period offset handling in analytics API calls\n2. Report-builder-2: Parallelize data fetching and fix state timing\n3. Report-builder-3: Fix legend period selection for offset indicators  \n4. Report-builder-4: Improve DOM element matching for org units\n\n**Testing Strategy:**\n- Create test report with indicator using -1 month period offset\n- Test across multiple org unit levels (facility, district, region)\n- Verify legend colors match correct period for offset calculations\n- Ensure consistent results when regenerating same report multiple times","acceptance_criteria":"- [ ] All sub-issues resolved and tested\n- [ ] Indicators with period offsets show correct values\n- [ ] Different org units show correct, distinct values  \n- [ ] Legend colors/images match the effective calculation period\n- [ ] Report generation produces consistent results across multiple runs\n- [ ] No data overwriting or state inconsistencies\n- [ ] Test suite covers all three issue types","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-20T08:59:27.309686+03:00","updated_at":"2025-10-20T08:59:27.309686+03:00","dependencies":[{"issue_id":"Report-builder-5","depends_on_id":"Report-builder-1","type":"parent-child","created_at":"2025-10-20T08:59:42.677098+03:00","created_by":"sean"},{"issue_id":"Report-builder-5","depends_on_id":"Report-builder-2","type":"parent-child","created_at":"2025-10-20T08:59:47.160478+03:00","created_by":"sean"},{"issue_id":"Report-builder-5","depends_on_id":"Report-builder-3","type":"parent-child","created_at":"2025-10-20T08:59:49.079292+03:00","created_by":"sean"},{"issue_id":"Report-builder-5","depends_on_id":"Report-builder-4","type":"parent-child","created_at":"2025-10-20T08:59:50.543082+03:00","created_by":"sean"}]}
